<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#99B7C6">
  <title><%= title %> | Ella Rises</title>
  <link rel="icon" type="image/png" href="/images/EllaRisesHeart.png">
  <link rel="apple-touch-icon" href="/images/EllaRisesHeart.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/EllaRisesHeart.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .dashboard-section {
      margin-bottom: 3rem;
    }

    .section-title {
      font-family: 'DM Serif Display', serif;
      font-size: 2rem;
      color: var(--primary);
      text-align: left;
      margin-bottom: 1rem;
      margin-left: 1.5rem;
      font-weight: 400;
    }

    .table-container {
      background: var(--pink-light);
      padding: 2rem;
      border-radius: 12px;
      margin-left: 1rem;
      margin-right: 1rem;
      overflow-x: auto;
    }

    .table-container table {
      margin-top: 0;
      background: white;
    }


    .truncate {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Enhanced Dashboard Metrics */
    .metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
      margin: 3rem 0;
      padding: 0;
    }

    @media (max-width: 1024px) {
      .metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .metrics {
        grid-template-columns: 1fr;
      }
    }

    .metric {
      background: linear-gradient(135deg, #9AB59D 0%, #8BA68E 100%);
      padding: 2.5rem 2rem;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 6px 20px rgba(154, 181, 157, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .metric::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      transition: all 0.5s ease;
    }

    .metric:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 30px rgba(154, 181, 157, 0.35);
    }

    .metric:hover::before {
      top: -30%;
      right: -30%;
    }

    .metric h3 {
      font-size: 3rem;
      color: white;
      margin-bottom: 0.75rem;
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      line-height: 1.2;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* Special handling for donations metric with longer numbers */
    .metric.donation-metric {
      grid-column: 1 / span 2;
      min-height: 180px;
      padding: 3rem 2.5rem;
    }

    .metric.donation-metric h3 {
      font-size: 3.5rem;
      line-height: 1.3;
    }

    /* Empty space styling - can be used for future content */
    .metric-empty {
      background: transparent;
      border: 2px dashed rgba(154, 181, 157, 0.3);
      border-radius: 16px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* Custom dashed border for Add More tile */
    .metric-add {
      border: 4px dashed #9AB59D;
      border-radius: 12px;
      background: transparent;
    }

    .metric-empty::after {
      content: 'Reserved for future content';
      color: rgba(154, 181, 157, 0.5);
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    @media (max-width: 1024px) {
      .metric.donation-metric {
        grid-column: span 2;
      }
      .metric-empty {
        display: none;
      }
    }

    @media (max-width: 640px) {
      .metrics {
        gap: 1rem;
        margin: 1.5rem 0;
      }

      .metric {
        min-height: 110px !important;
        max-height: 110px !important;
        height: 110px !important;
        padding: 1.5rem 1.2rem !important;
        box-sizing: border-box !important;
      }

      .metric h3 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .metric p {
        font-size: 0.85rem;
      }

      .metric.donation-metric {
        grid-column: span 1;
        min-height: 110px !important;
        max-height: 110px !important;
        height: 110px !important;
        padding: 1.5rem 1.2rem !important;
        box-sizing: border-box !important;
      }

      .metric.donation-metric h3 {
        font-size: 2rem;
      }

      .metric-empty {
        display: none;
      }

      .dashboard-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        padding-left: 0;
        padding-right: 0;
      }

      .dashboard-header h1 {
        font-size: 2rem;
      }

      .dashboard-header p {
        font-size: 1rem;
      }

      .tableau-embed {
        margin-top: 2rem;
        padding: 1.5rem;
      }

      .tableau-embed h2 {
        font-size: 1.5rem;
      }

      .tableau-embed iframe {
        height: 500px;
      }
    }

    .metric p {
      color: white;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }

    /* Dashboard Header */
    .dashboard-header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 3px solid #9AB59D;
    }

    .dashboard-header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .dashboard-header p {
      color: var(--text);
      font-size: 1.1rem;
      opacity: 0.8;
    }

    /* Tableau Embed Styling */
    .tableau-embed {
      margin-top: 4rem;
      padding: 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 2px solid #9AB59D;
    }

    .tableau-embed h2 {
      font-family: 'DM Serif Display', serif;
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #9AB59D;
    }

    .tableau-embed iframe {
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .tableau-embed .tableauPlaceholder {
      width: 100%;
      min-height: 600px;
    }

    .tableau-embed .tableauViz {
      width: 100% !important;
      border-radius: 8px;
    }

    /* Edit Mode Styles */
    .metrics.edit-mode .metric {
      cursor: pointer;
      position: relative;
    }

    .metrics.edit-mode .metric:hover {
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(206, 50, 91, 0.2);
    }

    .metrics.edit-mode .metric::after {
      content: '✎';
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
    }

    .metrics.edit-mode .metric:hover::after {
      opacity: 1;
    }

    /* Resize Handle Styles */
    .resize-handle {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #9AB59D;
      border-radius: 4px;
      z-index: 20;
      cursor: nwse-resize;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .metrics.edit-mode .metric:hover .resize-handle {
      opacity: 1;
    }

    .resize-handle.se {
      bottom: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      cursor: nwse-resize;
    }

    .resize-handle.se::after {
      content: '';
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 0 8px 8px;
      border-color: transparent transparent #9AB59D transparent;
    }

    /* Size indicator */
    .size-indicator {
      position: absolute;
      top: 5px;
      left: 5px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
    }

    .metrics.edit-mode .metric:hover .size-indicator {
      opacity: 1;
    }

    /* Color picker styles */
    .color-picker-group {
      margin-bottom: 1rem;
    }

    .color-picker-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .color-options {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .color-option {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .color-option.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(206, 50, 91, 0.3);
    }

    .color-option::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .color-option.selected::after {
      opacity: 1;
    }

    /* Size selector styles */
    .size-selector-group {
      margin-bottom: 1rem;
    }

    .size-selector-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .size-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      max-width: 200px;
    }

    .size-option {
      padding: 0.75rem;
      border: 2px solid var(--pink-light);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .size-option:hover {
      border-color: var(--secondary);
      background: var(--pink-light);
    }

    .size-option.selected {
      border-color: var(--secondary);
      background: var(--secondary);
      color: white;
    }

    /* Modal Styles */
    .metric-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .metric-modal.active {
      display: flex;
    }

    .metric-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .metric-modal-content h3 {
      margin-top: 0;
      color: var(--primary);
      font-family: 'DM Serif Display', serif;
    }

    .metric-modal-content input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid var(--pink-light);
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .metric-modal-content select {
      width: 100%;
      padding: 0.75rem 2.5rem 0.75rem 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid var(--pink-light);
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239AB59D' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .metric-modal-content select:hover {
      border-color: var(--secondary);
      box-shadow: 0 2px 10px rgba(154, 181, 157, 0.15);
    }

    .metric-modal-content select:focus,
    .metric-modal-content input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 4px 12px rgba(154, 181, 157, 0.2);
    }

    .metric-modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Edit Dashboard Button Styling */
    .btn-edit-dashboard {
      background: #FFD8D1;
      color: var(--text);
      border: 2px solid #F9AFB1;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .btn-edit-dashboard:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      background: #F9AFB1;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
      }

      .dashboard-header h1 {
        margin-bottom: 0.5rem;
      }

      .dashboard-header p {
        margin-bottom: 0;
      }

      .btn-edit-dashboard {
        width: 100%;
        justify-content: center;
      }

      .metrics {
        grid-template-columns: 1fr !important;
        gap: 1rem;
        margin: 1.5rem 0;
      }

      .metric {
        padding: 1.5rem 1.2rem !important;
        min-height: 110px !important;
        max-height: 110px !important;
        height: 110px !important;
        box-sizing: border-box !important;
      }

      .metric h3 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .metric p {
        font-size: 0.85rem;
      }

      .metric.donation-metric {
        grid-column: 1 !important;
        min-height: 110px !important;
        max-height: 110px !important;
        height: 110px !important;
        padding: 1.5rem 1.2rem !important;
        box-sizing: border-box !important;
      }

      .metric.donation-metric h3 {
        font-size: 2rem;
      }

      .metric-modal-content {
        width: 95%;
        padding: 1.5rem;
        margin: 1rem;
      }

      .tableau-embed {
        margin: 2rem 0;
        padding: 1rem;
      }

      .tableau-embed h2 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .metric {
        padding: 1.3rem 1rem !important;
        min-height: 100px !important;
        max-height: 100px !important;
        height: 100px !important;
        box-sizing: border-box !important;
      }

      .metric h3 {
        font-size: 1.8rem;
        margin-bottom: 0.4rem;
      }

      .metric p {
        font-size: 0.8rem;
      }

      .metric.donation-metric {
        min-height: 100px !important;
        max-height: 100px !important;
        height: 100px !important;
        padding: 1.3rem 1rem !important;
        box-sizing: border-box !important;
      }

      .metric.donation-metric h3 {
        font-size: 1.8rem;
      }

      .dashboard-header h1 {
        font-size: 2rem;
      }

      .dashboard-header p {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
<%- include('../partials/header') %>
<main class="container" style="padding-top: 2rem;">
  <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div>
      <h1>Dashboard</h1>
      <p>Overview of Ella Rises program metrics and analytics</p>
    </div>
    <!-- Edit Dashboard button temporarily hidden -->
    <!-- <button id="editDashboardBtn" class="btn btn-edit-dashboard" style="margin-top: 0;">
      <i class="fas fa-edit"></i> Edit Dashboard
    </button> -->
  </div>

  <div class="metrics" id="metricsContainer">
    <% 
      // Default tile configuration - will be replaced by localStorage if available
      const defaultTiles = [
        { table: 'participants', type: 'count', column: null, name: 'Participants', width: 1, height: 1, color: '#9AB59D', value: metrics.participants },
        { table: 'events', type: 'count', column: null, name: 'Events', width: 1, height: 1, color: '#9AB59D', value: metrics.events },
        { table: 'surveys', type: 'count', column: null, name: 'Surveys', width: 1, height: 1, color: '#9AB59D', value: metrics.surveys },
        { table: 'registrations', type: 'count', column: null, name: 'Registrations', width: 1, height: 1, color: '#9AB59D', value: metrics.registrations || 0 },
        { table: 'donations', type: 'sum', column: 'donation_amount', name: 'Total Donations', width: 2, height: 1, color: '#9AB59D', value: metrics.totalDonations },
        { table: 'milestones', type: 'count', column: null, name: 'Milestones', width: 1, height: 1, color: '#9AB59D', value: metrics.milestones }
      ];
      
      // Store default tiles in a script tag for JavaScript to use
      const tiles = (typeof tileConfig !== 'undefined' && tileConfig && tileConfig.length > 0) ? tileConfig : defaultTiles;
      
      tiles.forEach((tile, index) => {
        const displayValue = tile.type === 'sum' && tile.table === 'donations' 
          ? '$' + Math.round(parseFloat(tile.value || 0)).toLocaleString('en-US')
          : (tile.value || 0).toLocaleString();
    %>
    <div class="metric" 
         data-index="<%= index %>"
         data-table="<%= tile.table %>" 
         data-type="<%= tile.type %>" 
         data-column="<%= tile.column || '' %>"
         data-width="<%= tile.width || 1 %>"
         data-height="<%= tile.height || 1 %>"
         data-color="<%= tile.color || '#9AB59D' %>"
         style="grid-column: span <%= tile.width || 1 %>; grid-row: span <%= tile.height || 1 %>; background: linear-gradient(135deg, <%= tile.color || '#9AB59D' %> 0%, <%= tile.color || '#9AB59D' %>dd 100%);">
      <!-- Edit mode indicators temporarily hidden -->
      <!-- <span class="size-indicator"><%= tile.width || 1 %>x<%= tile.height || 1 %></span>
      <div class="resize-handle se"></div> -->
      <h3><%= displayValue %></h3>
      <p><%= tile.name %></p>
    </div>
    <% }); %>
    <!-- Add More tile temporarily hidden -->
    <!-- <div class="metric metric-add" id="addMetricTile" style="cursor: pointer; background: transparent;">
      <div style="font-size: 3rem; color: #9AB59D; margin-bottom: 0.75rem; font-weight: 700; font-family: 'Montserrat', sans-serif; line-height: 1.2;">⋯</div>
      <p style="color: #9AB59D; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Add More</p>
    </div> -->
  </div>

  <div class="tableau-embed">
    <h2>Program Impact & Effectiveness</h2>
    <div class='tableauPlaceholder' id='viz1764782639637' style='position: relative'><noscript><a href='#'><img alt='Ella Rises: Program Impact &amp; Effectiveness ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Et&#47;EthanJohnBlakeTaylorINTEX2&#47;Dashboard2&#47;1_rss.png' style='border: none' /></a></noscript><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' /> <param name='embed_code_version' value='3' /> <param name='site_root' value='' /><param name='name' value='EthanJohnBlakeTaylorINTEX2&#47;Dashboard2' /><param name='tabs' value='no' /><param name='toolbar' value='yes' /><param name='static_image' value='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Et&#47;EthanJohnBlakeTaylorINTEX2&#47;Dashboard2&#47;1.png' /> <param name='animate_transition' value='yes' /><param name='display_static_image' value='yes' /><param name='display_spinner' value='yes' /><param name='display_overlay' value='yes' /><param name='display_count' value='yes' /><param name='language' value='en-US' /><param name='filter' value='publish=yes' /></object></div>
    <script type='text/javascript'>
      var divElement = document.getElementById('viz1764782639637');
      var vizElement = divElement.getElementsByTagName('object')[0];
      if ( divElement.offsetWidth > 800 ) { 
        vizElement.style.width='100%';
        vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
      } else if ( divElement.offsetWidth > 500 ) { 
        vizElement.style.width='100%';
        vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
      } else { 
        vizElement.style.width='100%';
        vizElement.style.height='1327px';
      }
      var scriptElement = document.createElement('script');
      scriptElement.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
      vizElement.parentNode.insertBefore(scriptElement, vizElement);
    </script>
  </div>
</main>

<!-- Metric Customization Modal -->
<div class="metric-modal" id="metricModal">
  <div class="metric-modal-content">
    <h3>Customize Metric</h3>
    <form id="metricForm">
      <label>Table:</label>
      <select id="tableSelect" name="table" required>
        <option value="participants">Participants</option>
        <option value="events">Events</option>
        <option value="surveys">Surveys</option>
        <option value="registrations">Registrations</option>
        <option value="milestones">Milestones</option>
        <option value="donations">Donations</option>
        <option value="users">Users</option>
        <option value="event_occurrences">Event Occurrences</option>
      </select>
      
      <label>Metric Type:</label>
      <select id="typeSelect" name="type" required>
        <option value="count">Count (Total Records)</option>
        <option value="sum">Sum (Total Value)</option>
      </select>
      
      <label id="columnLabel" style="display: none;">Column to Sum:</label>
      <input type="text" id="columnInput" name="column" style="display: none;" placeholder="e.g., donation_amount">
      
      <label>Display Name:</label>
      <input type="text" id="nameInput" name="name" required placeholder="e.g., Total Participants">
      
      <div class="color-picker-group">
        <label>Tile Color:</label>
        <div class="color-options">
          <div class="color-option" data-color="#FFD8D1" style="background: #FFD8D1;"></div>
          <div class="color-option" data-color="#9AB59D" style="background: #9AB59D;"></div>
          <div class="color-option" data-color="#F4B092" style="background: #F4B092;"></div>
        </div>
        <input type="hidden" id="colorInput" name="color" value="#9AB59D">
      </div>
      
      <div class="size-selector-group">
        <label>Tile Size:</label>
        <div class="size-grid">
          <div class="size-option" data-width="1" data-height="1">1x1</div>
          <div class="size-option" data-width="2" data-height="1">2x1</div>
          <div class="size-option" data-width="1" data-height="2">1x2</div>
          <div class="size-option" data-width="2" data-height="2">2x2</div>
        </div>
        <input type="hidden" id="widthInput" name="width" value="1">
        <input type="hidden" id="heightInput" name="height" value="1">
      </div>
      
      <input type="hidden" id="metricIndex" name="index">
      
      <div class="metric-modal-actions">
        <button type="button" class="btn" onclick="closeMetricModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<%- include('../partials/footer') %>
<script src="/js/main.js"></script>
<script>
  let editMode = false;
  let currentEditingIndex = null;
  let isResizing = false;
  let resizeStartX = 0;
  let resizeStartY = 0;
  let resizeStartWidth = 1;
  let resizeStartHeight = 1;
  let currentResizeTile = null;

  // Load dashboard layout from localStorage on page load
  function loadLayoutFromStorage() {
    try {
      const saved = localStorage.getItem('dashboardTileConfig');
      if (saved) {
        const tileConfig = JSON.parse(saved);
        if (Array.isArray(tileConfig) && tileConfig.length > 0) {
          // Update existing tiles with saved config
          const tiles = document.querySelectorAll('.metric:not(#addMetricTile)');
          tileConfig.forEach((config, index) => {
            if (tiles[index]) {
              const tile = tiles[index];
              tile.dataset.width = config.width || 1;
              tile.dataset.height = config.height || 1;
              tile.dataset.color = config.color || '#9AB59D';
              tile.style.gridColumn = `span ${config.width || 1}`;
              tile.style.gridRow = `span ${config.height || 1}`;
              tile.style.background = `linear-gradient(135deg, ${config.color || '#9AB59D'} 0%, ${config.color || '#9AB59D'}dd 100%)`;
              const sizeIndicator = tile.querySelector('.size-indicator');
              if (sizeIndicator) {
                sizeIndicator.textContent = `${config.width || 1}x${config.height || 1}`;
              }
            }
          });
        }
      }
    } catch (error) {
      console.error('Error loading layout from localStorage:', error);
    }
  }

  // Load layout when page loads
  window.addEventListener('DOMContentLoaded', loadLayoutFromStorage);

  // Toggle edit mode - DISABLED TEMPORARILY
  // const editBtn = document.getElementById('editDashboardBtn');
  // if (editBtn) {
  //   editBtn.addEventListener('click', async function() {
  //     editMode = !editMode;
  //     const container = document.getElementById('metricsContainer');
  //     if (editMode) {
  //       container.classList.add('edit-mode');
  //       this.innerHTML = '<i class="fas fa-check"></i> Done Editing';
  //     } else {
  //       container.classList.remove('edit-mode');
  //       this.innerHTML = '<i class="fas fa-edit"></i> Edit Dashboard';
  //       // Save layout when exiting edit mode
  //       await saveLayout();
  //     }
  //   });
  // }

  // Color picker handlers
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('colorInput').value = this.dataset.color;
    });
  });

  // Size selector handlers
  document.querySelectorAll('.size-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('widthInput').value = this.dataset.width;
      document.getElementById('heightInput').value = this.dataset.height;
    });
  });

  // Resize handle mouse down
  document.addEventListener('mousedown', function(e) {
    if (!editMode) return;
    const handle = e.target.closest('.resize-handle');
    if (!handle) return;
    
    e.preventDefault();
    isResizing = true;
    currentResizeTile = handle.closest('.metric');
    resizeStartX = e.clientX;
    resizeStartY = e.clientY;
    resizeStartWidth = parseInt(currentResizeTile.dataset.width) || 1;
    resizeStartHeight = parseInt(currentResizeTile.dataset.height) || 1;
    
    document.body.style.cursor = 'nwse-resize';
    document.body.style.userSelect = 'none';
  });

  // Resize handle mouse move
  document.addEventListener('mousemove', function(e) {
    if (!isResizing || !currentResizeTile) return;
    
    const container = document.getElementById('metricsContainer');
    const containerRect = container.getBoundingClientRect();
    const tileRect = currentResizeTile.getBoundingClientRect();
    
    // Calculate relative position
    const relativeX = e.clientX - tileRect.left;
    const relativeY = e.clientY - tileRect.top;
    
    // Calculate grid cell size (container width / 4 columns)
    const gridCellWidth = containerRect.width / 4;
    const gridCellHeight = 150; // Approximate cell height
    
    // Calculate new dimensions based on mouse position
    let newWidth = Math.max(1, Math.min(2, Math.ceil(relativeX / gridCellWidth)));
    let newHeight = Math.max(1, Math.min(2, Math.ceil(relativeY / gridCellHeight)));
    
    // Update tile
    currentResizeTile.dataset.width = newWidth;
    currentResizeTile.dataset.height = newHeight;
    currentResizeTile.style.gridColumn = `span ${newWidth}`;
    currentResizeTile.style.gridRow = `span ${newHeight}`;
    currentResizeTile.querySelector('.size-indicator').textContent = `${newWidth}x${newHeight}`;
  });

  // Resize handle mouse up
  document.addEventListener('mouseup', function() {
    if (isResizing) {
      isResizing = false;
      currentResizeTile = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });

  // Handle metric clicks in edit mode - DISABLED TEMPORARILY
  // document.getElementById('metricsContainer').addEventListener('click', function(e) {
  //   if (!editMode) return;
  //   if (isResizing) return;
  //   
  //   // Don't open modal if clicking resize handle
  //   if (e.target.closest('.resize-handle')) return;
  //   
  //   const metric = e.target.closest('.metric');
  //   if (!metric || metric.id === 'addMetricTile') return;
  //   
  //   openMetricModal(metric);
  // });

  // Handle add metric tile click - DISABLED TEMPORARILY
  // const addTile = document.getElementById('addMetricTile');
  // if (addTile) {
  //   addTile.addEventListener('click', function() {
  //     if (!editMode) {
  //       const editBtn = document.getElementById('editDashboardBtn');
  //       if (editBtn) editBtn.click();
  //     }
  //     openMetricModal(null);
  //   });
  // }

  // Type select change handler
  document.getElementById('typeSelect').addEventListener('change', function() {
    const columnLabel = document.getElementById('columnLabel');
    const columnInput = document.getElementById('columnInput');
    if (this.value === 'sum') {
      columnLabel.style.display = 'block';
      columnInput.style.display = 'block';
      columnInput.required = true;
    } else {
      columnLabel.style.display = 'none';
      columnInput.style.display = 'none';
      columnInput.required = false;
    }
  });

  function openMetricModal(metric) {
    const modal = document.getElementById('metricModal');
    const form = document.getElementById('metricForm');
    
    if (metric) {
      // Editing existing metric
      const table = metric.dataset.table;
      const type = metric.dataset.type;
      const column = metric.dataset.column || '';
      const name = metric.querySelector('p').textContent;
      const index = metric.dataset.index;
      const width = parseInt(metric.dataset.width) || 1;
      const height = parseInt(metric.dataset.height) || 1;
      const color = metric.dataset.color || '#9AB59D';
      
      document.getElementById('tableSelect').value = table;
      document.getElementById('typeSelect').value = type;
      document.getElementById('columnInput').value = column;
      document.getElementById('nameInput').value = name;
      document.getElementById('metricIndex').value = index;
      document.getElementById('widthInput').value = width;
      document.getElementById('heightInput').value = height;
      document.getElementById('colorInput').value = color;
      
      // Set selected color
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === color) {
          opt.classList.add('selected');
        }
      });
      
      // Set selected size
      document.querySelectorAll('.size-option').forEach(opt => {
        opt.classList.remove('selected');
        if (parseInt(opt.dataset.width) === width && parseInt(opt.dataset.height) === height) {
          opt.classList.add('selected');
        }
      });
      
      if (type === 'sum') {
        document.getElementById('columnLabel').style.display = 'block';
        document.getElementById('columnInput').style.display = 'block';
      }
      
      currentEditingIndex = index;
    } else {
      // Adding new metric
      form.reset();
      document.getElementById('metricIndex').value = '';
      document.getElementById('widthInput').value = '1';
      document.getElementById('heightInput').value = '1';
      document.getElementById('colorInput').value = '#9AB59D';
      
      // Reset color and size selections
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.color-option[data-color="#9AB59D"]').classList.add('selected');
      document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.size-option[data-width="1"][data-height="1"]').classList.add('selected');
      
      currentEditingIndex = null;
    }
    
    modal.classList.add('active');
  }

  function closeMetricModal() {
    document.getElementById('metricModal').classList.remove('active');
    document.getElementById('metricForm').reset();
    currentEditingIndex = null;
  }

  // Save layout to localStorage (no database needed!)
  async function saveLayout() {
    const tiles = Array.from(document.querySelectorAll('.metric:not(#addMetricTile)'));
    const tileConfig = tiles.map(tile => ({
      table: tile.dataset.table,
      type: tile.dataset.type,
      column: tile.dataset.column || null,
      name: tile.querySelector('p').textContent,
      width: parseInt(tile.dataset.width) || 1,
      height: parseInt(tile.dataset.height) || 1,
      color: tile.dataset.color || '#9AB59D'
    }));

    try {
      // Save to browser localStorage - works immediately, no database needed!
      localStorage.setItem('dashboardTileConfig', JSON.stringify(tileConfig));
      console.log('Dashboard layout saved to browser storage');
    } catch (error) {
      console.error('Error saving layout to localStorage:', error);
    }
  }

  // Handle form submission
  document.getElementById('metricForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const index = formData.get('index');
    const width = parseInt(formData.get('width')) || 1;
    const height = parseInt(formData.get('height')) || 1;
    const color = formData.get('color') || '#9AB59D';
    
    // If editing existing tile, update it
    if (index !== null && index !== '' && index !== undefined) {
      const tile = document.querySelector(`.metric[data-index="${index}"]`);
      if (tile) {
        tile.dataset.table = formData.get('table');
        tile.dataset.type = formData.get('type');
        tile.dataset.column = formData.get('column') || '';
        tile.dataset.width = width;
        tile.dataset.height = height;
        tile.dataset.color = color;
        tile.style.gridColumn = `span ${width}`;
        tile.style.gridRow = `span ${height}`;
        tile.style.background = `linear-gradient(135deg, ${color} 0%, ${color}dd 100%)`;
        tile.querySelector('p').textContent = formData.get('name');
        const sizeIndicator = tile.querySelector('.size-indicator');
        if (sizeIndicator) {
          sizeIndicator.textContent = `${width}x${height}`;
        }
        
        // Reload page to get updated metric value
        await saveLayout();
        location.reload();
        return;
      }
    }
    
    // For new tiles, we'll need to reload to add them properly
    // This is a simplified approach - in a full implementation, you'd add the tile dynamically
    await saveLayout();
    location.reload();
  });

  // Close modal on outside click
  document.getElementById('metricModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeMetricModal();
    }
  });
</script>
</body>
</html>
